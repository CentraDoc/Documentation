<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Liberty Systems CentraDoc: GCO Part 1 - Generic C Objects</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="centradoc.png"/></td>
  <td id="projectalign">
   <div id="projectname">Liberty Systems CentraDoc
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('gcodocs1.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">GCO Part 1 - <a class="el" href="class_generic.html" title="ref Generic, IGeneric, IGenericFactory and the C API starting with Generic_ in gco/gcobase....">Generic</a> C Objects </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a class="anchor" id="md_gco_gcodocs1"></a></p>
<h1><a class="anchor" id="autotoc_md0"></a>
Document map:</h1>
<ul>
<li><a class="el" href="gcodocs1_8md.html">gcodocs1.md</a> - This document - introduction and basics</li>
<li><a class="el" href="gcodocs2_8md.html">gcodocs2.md</a> - more in depth discussion of <a class="el" href="class_generic.html" title="ref Generic, IGeneric, IGenericFactory and the C API starting with Generic_ in gco/gcobase....">Generic</a> and details</li>
</ul>
<h1><a class="anchor" id="autotoc_md1"></a>
Topics:</h1>
<ul>
<li>Introduction<ul>
<li>GCO</li>
<li>lidl.py</li>
<li>lidl.cfg</li>
<li>GCO Design Principles</li>
</ul>
</li>
<li>Module Syntax<ul>
<li>/*Doc*/ Comments</li>
<li>InheritsFrom or Uses</li>
<li>PublicInclude</li>
<li>PrivateInclude</li>
<li>Public</li>
<li>Private</li>
<li>Forward, Extern, Class ;</li>
<li>Class<ul>
<li>Class Modifiers<ul>
<li>Leaf</li>
<li>LTS</li>
<li>PublicInstance</li>
<li>Public</li>
<li>PublicFactory</li>
<li>Pure</li>
</ul>
</li>
<li>Class Sections<ul>
<li>factory</li>
<li>instance</li>
<li>override</li>
</ul>
</li>
<li>Instance and Factory</li>
</ul>
</li>
<li>Other Directives:<ul>
<li>#lidl comment</li>
<li>#// lidl comment</li>
<li>#/* lidl comment block */</li>
<li>@Pymacro escape</li>
<li>Pymacro block }</li>
<li>@Path{...}</li>
<li>&lt;Pymacro escape Now&gt;</li>
</ul>
</li>
</ul>
</li>
<li>Some Examples</li>
<li>GCO Modules/Classes<ul>
<li>cutils - standard c utility macros</li>
<li>sysalloc - malloc/calloc wrapper</li>
<li>sysframe - exception and error handling</li>
<li>generic<ul>
<li><a class="el" href="class_generic.html" title="ref Generic, IGeneric, IGenericFactory and the C API starting with Generic_ in gco/gcobase....">Generic</a> - root of the class tree</li>
</ul>
</li>
<li>pgarray<ul>
<li>PgArray - Paged Array - fixed size elements</li>
<li>FxAlloc - fixed size allocator</li>
<li>StringPool - for storing multiple readonly strings</li>
</ul>
</li>
<li>strmap</li>
</ul>
</li>
<li>GCO Dependency information</li>
<li>Regarding Liberty integration</li>
</ul>
<h1><a class="anchor" id="autotoc_md2"></a>
Introduction</h1>
<p >What is a class? Without going into Object Theory too much, a class is a data type, with 3 key ingredients:</p>
<ol type="1">
<li>state (variables)</li>
<li>behavior (methods/functions)</li>
<li>substitutability (inheritance and virtual methods/polymorphism/late binding)</li>
</ol>
<p >The model we are using is Factory and Instance. For each class there is a Factory, with variables and methods, that produces instances of the class, which have their own variables and methods.</p>
<p >Defining a class requires the following minimum parameters:</p><ul>
<li>The Parent class</li>
<li>Factory Variables and Methods</li>
<li>Instance Variables and Methods</li>
<li>Specified overrides</li>
</ul>
<h1><a class="anchor" id="autotoc_md3"></a>
GCO</h1>
<p >GCO provides a way of building classes in C without resorting to C++. A module consists of the .c and .d files. The lidl compiler is used to create the .h and file from the .d file. The .c file should <code>#define IMPLEMENT_@MODULE@</code>, (where <code>@MODULE@</code> is the upper case module name from the .d file), and then include the .h file as its first #include.</p>
<p >Another module that needs access to the private definitions can <code>#define FRIEND_@MODULE@</code>. Two modules won't link if they both <code>#define IMPLEMENT_@MODULE@</code> (public data is declared).</p>
<p >lidl.py is based on pymacro, so the pymacro syntax applies - see pymacro.py for more information. Most of the lidl code is actually in classmax.py.</p>
<p >lidl.cfg contains the default <code>@Path{x;x;x}</code> directive. There is a global lidl.cfg in the lidl.py directory, and an additional lidl.cfg can be placed in the .d directory. lidl.cfg can contain any pymacro directives, for now Path is the only likely one needed.</p>
<h1><a class="anchor" id="autotoc_md4"></a>
GCO Design Principles</h1>
<p >Design Principles</p>
<ul>
<li>C classes</li>
<li>simple to implement</li>
<li>acceptable performance</li>
<li>minimal impact on Liberty code base - includes adaptable naming conventions</li>
<li>strong typing; explicit conversion up the type tree required<ul>
<li>flexible memory management<ul>
<li>initially, replacable allocator</li>
<li>static allocation support as needed (in C++: 'placement new')</li>
<li>considering suballocation: alloc chunk, then subchunks, free all in one fell swoop</li>
<li>logging / tracking (for finding leaks)</li>
<li>considering Memory Limit Alerts - waiting till out of memory is too late</li>
</ul>
</li>
</ul>
</li>
<li>ClassLibrary - a useful set of base classes</li>
<li>COMpatibility - dropped - unlikely it will ever be needed</li>
<li>Looking at enhancements for generating documentation</li>
</ul>
<h1><a class="anchor" id="autotoc_md5"></a>
Module Syntax</h1>
<p >Directives are either keyword-led or punctuation-led. Some directives require blocks using { and }. A trailing ';' is allowed on the '}', but not required. Keywords are not case sensitive.</p>
<h1><a class="anchor" id="autotoc_md6"></a>
Expanded description</h1>
<pre class="fragment">/*
        comments / documentation about this module
*/

InheritsFrom module_name
    Required if a class inherits from a class in another_module_name
        if not specified, "generic" is assumed

PublicInclude module_name(s)
    #includes module.h in the public interface
    required if something in module.h is used in public, as in, a parameter

PrivateInclude module_name(s)
    #includes module.h in the private interface
    required if something in module.h is only used in private, as in, a field

ProtectedInclude module_name(s)
    #includes module.h in the protected interface
    required if something in module.h is only used in private, as in, a field,
    and this class is a (potential) parent of another class

Public {
        /* any C declarations needed in the public interface */
}

Private {
        /* any C declarations needed in the private implementation */
}

Protected {
        /* any C declarations needed in the protected implementation */
}

Forward NAME;  or Extern NAME;  or Class NAME;
    These are all the same shortcut for defining a ClassPtr type
    without including the class, or in cases where
    classes in the same module are interdependent, and
    one has to be forward declared in order to make the pointer type
    available to the other.

[Modifiers] Class NAME [: PARENT] {
/*
    Documentation string for this class
*/
instance:       /* for instance fields and methods */
    field definitions for the instance structure
    no initializers allowed
    by default all instance variables are cleared to 0
    functions provided by the instance
    instance methods can = 0 for abstract (no implementation provided)
    abstract classes can not be instantiated (construct will fail)
    Instance is the first argument to all instance methods

factory:        /* for factory (global) fields and methods */
    field definitions for the factory structure
    with initializer = something

    functions provided by the factory
    no abstract factory methods allowed
    Factory is the first (implied) argument to all factory methods
    Constructors return an Instance
    For Example:

        Instance   Make(Factory);        /* default constructor */

override:       /* for overriding inherited methods or globals */
    names to override for methods
    names and = value to override factory variable initializers
    name=full spec to override factory methods

keep:           /* for complete classes, opposite of override */
    names to keep for methods
    classname also works; all methods from specified class
    the keep mechanism doesn't inherit, it has to be restated
}
</pre><p> Modifiers can be any of:</p>
<p ><code>LTS Leaf Public Complete PublicInstance PublicFactory PublicClass</code></p>
<p >LTS is now the default </p><pre class="fragment">The standard method naming conventions are:
    for calls:
            Class_Method or
            CLASS_Method

    for definitions:
            S_ClassMethod

Leaf
    Mark this class as a leaf -
    any calls to defined methods are direct calls, not through the vtable.

    S_ClassMethod will still work as a definition, so Leaf is transparent
    to a functional class.

    In addition, CLASS_Method will work, which matches existing LTS code.

PublicInstance
    Make the instance type declaration public

Public
    A shortcut for PublicInstance

PublicClass or PublicFactory
    Make the class/factory type declaration public

Pure
    Shorthand for = 0 on all methods.
    No factory methods can be declared.
    Variables can be declared, and overrides are allowed,
            but this may violate the "Pure" spirit

Complete
    Shorthand for override all instance methods above the base (Generic)
    keep: can be used to do the opposite of override.

    For some classes, we'd like to be sure we implement everything,
    so if something is added to the base, we know we've looked at it.
</pre> <h1><a class="anchor" id="autotoc_md7"></a>
About Instance and Factory</h1>
<p >C has no concept of a type hierarchy, a type is either correct, incorrect, or unchecked. Instance and Factory are substituted by lidl with the correct type of the current instance or class pointers. So Generic_Make returns a GenericPtr, Another_Make returns AnotherPtr, without any need to redeclare the signature of Make.</p>
<p >lidl has been changed to recognize the typed ptrs, and correctly handle inheritance. For Class X, XPtr can be used in place of Instance, and XClassPtr in place of Factory. This makes the declared signature look closer to what is expected.</p>
<p >Note: in cases where an XPtr is required, even for child class Y, X * can be used and will not get substituted with Y *.</p>
<h1><a class="anchor" id="autotoc_md8"></a>
All other directives:</h1>
<h1><a class="anchor" id="autotoc_md9"></a>
lidl comment</h1>
<p >#// lidl comment</p>
<p >#/* lidl comment block */ </p><pre class="fragment">   At the moment, comments can only occur first on a line.
   In other words:
           Directive something   # with a comment
   Doesn't work.
   Comment syntax is also somewhat senstive to spaces.
</pre><p> @Pymacro escape</p>
<p >Pymacro block } lidl is based on Pymacro, occasionally it can still be useful to access it directly</p>
<p >#// for example: @Path{string with ;} specify the @Uses search path typically found in the lidl.cfg file</p>
<p >&lt; Python block &gt; sometimes straight Python is useful. (how does this differ from}?)</p>
<h2><a class="anchor" id="autotoc_md10"></a>
Some Examples</h2>
<pre class="fragment">#// a simple inheritance example

Public {

    typedef struct tagPoint
    {
            int x, y;
    } Point;

    typedef struct tagRect
    {
            Point topLeft;
            Point bottomRight;
    } Rect;

}

Pure Class GrafElem
{
     void GetBounds(GrafElemPtr, Rect *);
     void SetBounds(GrafElemPtr, Rect *);
     void Draw(GrafElemPtr);
}

Class Polyline : GrafElem
{
     PolylinePtr New(PolylineClassPtr klass, Point *points, int nPoints);
override:
     GetBounds
     SetBounds
     Draw
}

#// example overriding a factory method - sometimes appropriate

Class Polygon : Polyline
{
override:
     New=PolygonPtr New(PolygonClassPtr klass, Point *points, int nPoints, int evenodd);
}
</pre><h2><a class="anchor" id="autotoc_md11"></a>
GCO modules</h2>
<ul>
<li>rt_utils - some standard utility items primarily string, memory, and assert stuff, some common macros, things like numberof, CLEAR, COPY, CHECK, ALWAYS, etc. cutils includes &lt;string.h&gt;</li>
<li>rt_alloc - a wrapper around &lt;stdlib.h&gt; malloc sysalloc provides a way to track information about allocations, the number of allocations, the number of bytes allocated, where the allocations occur, some simple fencepost checks, etc. sysalloc has a variety of layers of features by default: ifdef NDEBUG none of them are enabled, ifdef NDEBUG all are enabled except for full logging</li>
<li>rt_except - exception and error handling ERR_TRY, FAILURE, WARNING, ALWAYS, etc.</li>
<li>gcoreport - provides allocation reports from sysalloc and generic, writes to stdout. can view allocated blocks and class instances, can view a leak report that shows what hasn't been deallocated.</li>
<li>profiler - WIN32 only, provides support for tracking timing prof_enter("NAME") / prof_exit("NAME") / prof_report(FILE *)</li>
<li>gprepost - WIN32 only, provides hooks for pre and post method calls, primarily used for profiling class_profiling(gClass)</li>
<li>gcobase - the base of the GCO Class tree classes: <a class="el" href="class_generic.html" title="ref Generic, IGeneric, IGenericFactory and the C API starting with Generic_ in gco/gcobase....">Generic</a> functions: GCO_VisitClasses(void *, visitor func) macro/functions: class = <a class="el" href="gcoutils_8h.html#a4df5d6dccb4a36fc59da8a55f2543519">GCO_ClassOf(Instance)</a></li>
<li>pgarray PgArray - Paged Array of fixed size records FxAlloc (wasa PgArray) - Fixed size record allocator <a class="el" href="class_generic.html" title="ref Generic, IGeneric, IGenericFactory and the C API starting with Generic_ in gco/gcobase....">Generic</a> has a built in mechanism for automatically using FxAlloc for a class allocator StringPool (hasa PgArray) - for storing multiple readonly strings</li>
<li>strmap StrMap - a string/dictionary/associative array, stores one (or two) void *(s) based on a single (short &lt; 256) string StrMapIterator - for walking a StrMap</li>
</ul>
<h2><a class="anchor" id="autotoc_md12"></a>
GCO Dependency information</h2>
<p >The 'system base':</p>
<ul>
<li>C Compiler, minimal ANSI subset<ul>
<li>C89 plus // style comments</li>
<li>although // comments could be eliminated, they are present in some of the vendor dependencies</li>
<li>Standard C Library</li>
<li>Some platform specific support for<ul>
<li>Windows</li>
<li>macOS</li>
<li>Linux</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md13"></a>
Other notes</h2>
<p >Ideally, the lidl compile command would be part of the build process, and the .h file generated automatically at build time. This is only currently supported by Liberty's build.py build system, so the .h files generated by that system are checked in to the repository and distributed.</p>
<p >...</p>
<h2><a class="anchor" id="autotoc_md14"></a>
Hacks</h2>
<ul>
<li>ImplementPrefix</li>
</ul>
<p >Inside the class, this call: &lt;ImplementPrefix{BLAH_}&gt; will change the method implementation prefix (default is S_@CLASS@) The &lt;syntax&gt; is a trick to tell lidl "run this macro right now" as opposed to running them at .h generation/output time. This is a bit subtle, but an interesting place to program the process.</p>
<ul>
<li>data #define macros</li>
</ul>
<p >Normally, ( ) in a definition tells lidl that the item is a method instead of a variable definition (the parser isn't brilliant). Sometimes #define MACRO(X) is used to construct a complex data definition, so MACRO(X) is detected by the parser as a macro, because it's ONEWORD(X) where a method would be at least TWO WORDS(X). If you try anything tricky, this might break. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon May 8 2023 15:18:03 for Liberty Systems CentraDoc by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
